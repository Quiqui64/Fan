// GPIO3 (BCM numbering, physical pin 5) will trigger a boot on the Raspberry Pi
// Use a 470ohm resistor on the base of transistor
// if OTA ask for password, just put in some radom number

#include <Wire.h>
#include <BH1750.h>
#include <ESP8266WiFi.h>
#include <ESP8266Ping.h> // install via Library Manager
#include <ESP8266HTTPClient.h> // Added for Hubitat to send indications
#include <ArduinoOTA.h>
#include <ESP8266WebServer.h> // For RF Transmitter
#include <IRremoteESP8266.h> // For RF Transmitter
#include <IRsend.h> // For RF Transmitter
#include <EEPROM.h> // For RF Transmitter

// config for fans RF Transmitter
ESP8266WebServer server(80); // Use port 80
const uint16_t kIrLed = 12;  // ESP8266 GPIO 12 (D6) output.
IRsend irsend(kIrLed);  // Set the GPIO to be used to sending the message.
const int IRrepeat = 20; // Number times to transmit signal

// === WiFi / Ping config ===
const char* WIFI_SSID     = "SSID";
const char* WIFI_PASSWORD = "password";
const char* PING_TARGET1  = "192.168.1.176"; // Raspberry Pi 4
const char* PING_TARGET2  = "192.168.1.180"; // Hubitat Hub

// === WiFi timeout / recovery ===
const unsigned long WIFI_CONNECT_TIMEOUT_MS = 30000UL; // 30 seconds

// === BH1750 / polling ===
BH1750 lightMeter;
const unsigned long POLL_INTERVAL_MS = 60000UL; // 60 seconds
unsigned long lastPoll = 0;
const float LUX_THRESHOLD = 3.0; // Your new threshold

// === Ping timing ===
const unsigned long PING_DELAY_MS = 300000UL; // 5 minutes
bool initialPingsDone = false; // Flag to ensure pings only run once

// === Hubitat hub information ===
const String hubIp = "192.168.1.180";
const unsigned int hubPort = 39501; // Hubitat hub port
const String accessToken = "1e77eafa-4963-4d4c-bebd-45b75c88db79";
const String appID = "2594";
const String deviceID = "1186";
const String HE_CMD_ON = "on";  // Hubitat command when lux > 3
const String HE_CMD_OFF = "off"; // Hubitat command when lux < 3
WiFiClient client; //client

// === threshold state tracking ===
bool lastStateValid = false;
bool lastIsOn = false; // Will track if lux is > 3

// === Pulse config ===
enum PulseStage { NOT_SCHEDULED, SCHEDULED, ACTIVE, DONE };

// === pulse1 config & state (non-blocking) for host #1 ping 176, pulse GPIO5 D1 ===
const uint8_t PULSE1_PIN = 5;
const unsigned long PULSE1_DELAY_MS = 60000UL; // wait 1 minute after boot before pulsing
const unsigned long PULSE1_WIDTH_MS = 10000UL;   // 10.0 second pulse
PulseStage pulse1Stage = NOT_SCHEDULED;
unsigned long pulse1StartDeadline = 0;
unsigned long pulse1ActiveStart = 0;

// Pulse2: ping 180, pulse GPIO4 D2
const uint8_t PULSE2_PIN = 4; //GPIO4 D2
const unsigned long PULSE2_DELAY_MS = 60000UL; // wait 1 minute after boot before pulsing
const unsigned long PULSE2_WIDTH_MS = 500UL;    // 0.5 second pulse
PulseStage pulse2Stage = NOT_SCHEDULED;
unsigned long pulse2StartDeadline = 0;
unsigned long pulse2ActiveStart = 0;

unsigned long bootMillis = 0;

// === NEW: EEPROM Data Structure ===
// This struct holds all your fan settings.
// Using a struct with EEPROM.put/get is safer and faster.
struct FanConfig {
  // Use char arrays instead of Strings for EEPROM
  char fan0001_Speed[8];  // "off", "low", "med", "high"
  char fan0001_Light[8];  // "off", "20", "30", ... "100"
  char fan1011_Speed[8];
  char fan1011_Light[8];
  char fan1100_Speed[8];
  char fan1100_Light[8];
  char fan1110_Speed[8];
  char fan1110_Light[8];
  char fan1111_Speed[8];
  char fan1111_Light[8];
  char fan1101_Speed[8];
  char fan1101_Light[8];

  // Add a "magic number" to know if it's initialized
  unsigned long magic;
};

FanConfig fanSettings; // Global variable to hold all settings
const unsigned long EEPROM_MAGIC = 0x1A2B3C4D; // A random number to check initialization

// === WiFi connect helper (blocking with timeout and restart) ===
void wifiConnectOrRestart(unsigned long timeoutMs = WIFI_CONNECT_TIMEOUT_MS) {
  //Serial.print("Connecting to WiFi ");
  //Serial.print(WIFI_SSID);
  //Serial.print(" ... ");

  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  unsigned long start = millis();
  while (WiFi.status() != WL_CONNECTED) {
    yield(); // keep system responsive
    if (millis() - start >= timeoutMs) {
      //Serial.println();
      //Serial.println("WiFi connect timed out; restarting...");
      delay(100);
      ESP.restart();
    }
  }
  
  //Serial.println(" WiFi connected.");
  //Serial.print("IP: ");
  //Serial.println(WiFi.localIP());
}

// === NEW: setupEEPROM using struct ===
void setupEEPROM() {
  EEPROM.begin(sizeof(FanConfig)); // Allocate space for our struct
  
  // Read the entire struct from EEPROM
  EEPROM.get(0, fanSettings);

  // Check the magic number
  if (fanSettings.magic != EEPROM_MAGIC) {
    // Not initialized. Set defaults.
    //Serial.println("EEPROM not initialized or corrupt. Setting defaults.");
    
    strcpy(fanSettings.fan0001_Speed, "off");
    strcpy(fanSettings.fan0001_Light, "off");
    strcpy(fanSettings.fan1011_Speed, "off");
    strcpy(fanSettings.fan1011_Light, "off");
    strcpy(fanSettings.fan1100_Speed, "off");
    strcpy(fanSettings.fan1100_Light, "off");
    strcpy(fanSettings.fan1110_Speed, "off");
    strcpy(fanSettings.fan1110_Light, "off");
    strcpy(fanSettings.fan1111_Speed, "off");
    strcpy(fanSettings.fan1111_Light, "off");
    strcpy(fanSettings.fan1101_Speed, "off");
    strcpy(fanSettings.fan1101_Light, "off");

    fanSettings.magic = EEPROM_MAGIC; // Set the magic number

    // Write the *entire* struct back to EEPROM
    EEPROM.put(0, fanSettings);
    EEPROM.commit();
    // EEPROM.commit() is part of EEPROM.put()
  } else {
    //Serial.println("EEPROM config loaded.");
  }
}

void setup() {
//  Serial.begin(115200);
  Wire.begin(2, 14); // SDA = GPIO2 (D4), SCL = GPIO14 (D5) for I2C

  if (!lightMeter.begin(BH1750::CONTINUOUS_HIGH_RES_MODE)) {
    //Serial.println("BH1750 not found");
  } else {
   // Serial.println("BH1750 initialized");
  }

  // initialize pulse pins
  pinMode(PULSE1_PIN, OUTPUT);
  digitalWrite(PULSE1_PIN, LOW);
  pinMode(PULSE2_PIN, OUTPUT);
  digitalWrite(PULSE2_PIN, LOW); // You confirmed this is correct

  // record boot reference
  bootMillis = millis();

  // schedule first BH1750 read immediately
  lastPoll = millis() - POLL_INTERVAL_MS;

  // Connect to WiFi, blocking with timeout and restart on failure
  wifiConnectOrRestart(WIFI_CONNECT_TIMEOUT_MS);

  // Start OTA
  ArduinoOTA.setHostname("frogLuxSensor"); // Optional: custom OTA hostname
  //ArduinoOTA.onStart([]() { Serial.println("OTA Start"); });
  //ArduinoOTA.onEnd([]() { Serial.println("OTA End"); });
  ArduinoOTA.begin();
  
  // config for fans RF Transmitter
  setupEEPROM(); // Use new EEPROM function
  irsend.begin();// For the RF transmitter
  
  server.on("/0001",set0001);
  server.on("/1011",set1011);// Family Room
  server.on("/1100",set1100);
  server.on("/1110",set1110);
  server.on("/1111",set1111);
  server.on("/1101",set1101);//Patio Fan
  server.begin();
}

// === NEW: sendToHubitat (sends "on" or "off") ===
// This is now non-blocking and memory-safe.
void sendToHubitat(String command) {
  HTTPClient http;

  // Create a buffer for the URL. 256 bytes is safe.
  char hubitatUrl[256]; 

  // Use snprintf to safely build the URL (prevents String fragmentation)
  // The command (on/off) is now part of the URL path
  snprintf(hubitatUrl, sizeof(hubitatUrl),
           //"http://%s:%u/apps/api/%s/devices/%s/%s?access_token=%s",
           "http://%s/apps/api/%s/devices/%s/%s?access_token=%s",
           hubIp.c_str(),     // %s
           //hubPort,           // %u
           appID.c_str(),     // %s
           deviceID.c_str(),  // %s
           command.c_str(),   // %s (This will be "on" or "off")
           accessToken.c_str() // %s
          );
  
    //Serial.print("Sending to Hubitat: ");
    //Serial.println(hubitatUrl);

  if (http.begin(client, hubitatUrl)) {
    
    // Send an HTTP GET request. This is standard for Maker API commands.
    int httpCode = http.GET(); 

    if (httpCode > 0) {
      //Serial.printf("[HTTP] GET... code: %d\n", httpCode);
    } else {
      //Serial.printf("[HTTP] GET... failed, error: %s\n", http.errorToString(httpCode).c_str());
    }
  } else {
    //Serial.println("HTTP client failed to begin.");
  }
  
  // CRITICAL: Add http.end() to prevent memory leak
  http.end(); 
}

// === sendRAW_Flash function (no changes) ===
void sendRAW_Flash(const unsigned int * signalArray, unsigned int signalLength, unsigned char carrierFreq) {
  irsend.enableIROut(carrierFreq);
  for (unsigned int i=0;i<signalLength;i++){
    if (i & 1) irsend.space(pgm_read_word_near(&signalArray[i]));
    else irsend.mark(pgm_read_word_near(&signalArray[i]));
  }
  irsend.space(1);
}

// === UPDATED: set0001 (using EEPROM struct) ===
void set0001() {  
  //FAN CHQ8BT7096T DIP SWITCHES DN,DN,DN,UP OR 0001
  static const unsigned int lightOffFanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,10035};
  static const unsigned int lightOffFanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,10039};
  static const unsigned int lightOffFanMed[] PROGMEM = {329,329,663,329,663,329,663,329,663,663,329,663,329,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,10042};
  static const unsigned int lightOffFanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,663,330,10040};
  static const unsigned int light20FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,10044};
  static const unsigned int light20FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,662,331,331,662,662,331,331,662,331,662,662,331,662,331,662,331,331,662,662,331,662,331,662,331,662,331,10043};
  static const unsigned int light20FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,662,331,331,662,662,331,331,662,331,662,662,331,662,331,331,662,331,662,662,331,662,331,662,331,331,662,10048};
  static const unsigned int light20FanHigh[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,662,331,331,662,662,331,331,662,331,662,662,331,331,662,662,331,331,662,662,331,662,331,331,662,662,331,10042};
  static const unsigned int light30FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,10041};
  static const unsigned int light30FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,662,331,331,662,331,662,662,331,331,662,331,662,662,331,662,331,331,662,662,331,331,662,662,331,331,662,10052};
  static const unsigned int light30FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,10048};
  static const unsigned int light30FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,330,663,10050};
  static const unsigned int light40FanOff[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,662,330,662,330,330,662,330,662,662,330,662,330,662,330,662,330,662,330,330,662,330,662,330,662,330,662,330,662,330,662,662,330,10041};
  static const unsigned int light40FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,662,331,331,662,331,662,662,331,331,662,331,662,10041};
  static const unsigned int light40FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,10043};
  static const unsigned int light40FanHigh[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,662,331,662,331,662,331,662,331,331,662,662,331,331,662,331,662,331,662,662,331,331,662,10046};
  static const unsigned int light50FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,10039};
  static const unsigned int light50FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,662,331,331,662,662,331,331,662,662,331,662,331,331,662,662,331,662,331,662,331,662,331,10041};
  static const unsigned int light50FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,662,331,331,662,662,331,331,662,662,331,331,662,331,662,662,331,662,331,662,331,331,662,10048};
  static const unsigned int light50FanHigh[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,662,331,331,662,662,331,331,662,331,662,662,331,331,662,662,331,662,331,331,662,662,331,10050};
  static const unsigned int light60FanOff[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,331,662,662,331,331,662,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,10046};
  static const unsigned int light60FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,331,662,662,331,331,662,662,331,662,331,662,331,331,662,662,331,331,662,662,331,331,662,10048};
  static const unsigned int light60FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,662,331,331,662,662,331,331,662,662,331,662,331,331,662,331,662,662,331,331,662,331,662,662,331,10054};
  static const unsigned int light60FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,10040};
  static const unsigned int light70FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10054};
  static const unsigned int light70FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,10041};
  static const unsigned int light70FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10044};
  static const unsigned int light70FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10052};
  static const unsigned int light80FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,10048};
  static const unsigned int light80FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,331,662,662,331,331,662,662,331,662,331,662,331,662,331,331,662,662,331,662,331,662,331,662,331,10046};
  static const unsigned int light80FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,331,662,662,331,331,662,662,331,662,331,662,331,331,662,331,662,662,331,662,331,662,331,331,662,10041};
  static const unsigned int light80FanHigh[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,331,662,662,331,331,662,662,331,662,331,331,662,662,331,331,662,662,331,662,331,331,662,662,331,10043};
  static const unsigned int light90FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,10030};
  static const unsigned int light90FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,331,662,662,331,662,331,331,662,662,331,331,662,662,331,331,662,10045};
  static const unsigned int light90FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,10041};
  static const unsigned int light90FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,330,663,10039};
  static const unsigned int light100FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10035};
  static const unsigned int light100FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,663,330,10035};
  static const unsigned int light100FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10033};
  static const unsigned int light100FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10035};

  server.send(204,""); // Send empty response immediately

  // Get values from the global struct
  String lastFanSpeed = String(fanSettings.fan0001_Speed);
  String lastLightState = String(fanSettings.fan0001_Light);  

  String fanSpeed = server.arg("fanSpeed");
  String lightState = server.arg("lightState");
  
  bool settingsChanged = false;
  
  if(fanSpeed == "same"){
    fanSpeed = lastFanSpeed;
  }
  else{
    // Copy new value into the struct
    strcpy(fanSettings.fan0001_Speed, fanSpeed.c_str());
    settingsChanged = true;
  }
  
  if(lightState == "same"){
    lightState = lastLightState;
  }
  else{
    // Copy new value into the struct
    strcpy(fanSettings.fan0001_Light, lightState.c_str());
    settingsChanged = true;
  }  
  
  // Only write to EEPROM if something actually changed
  // This saves wear-and-tear on the flash memory
  if (settingsChanged) {
    EEPROM.put(0, fanSettings);
    EEPROM.commit();
  }
  
  for (int i = 0; i <= IRrepeat; i++) {
     yield();  // This is PERFECT, keeps the ESP responsive
    if (lightState == "off") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(lightOffFanOff, 44,38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(lightOffFanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(lightOffFanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(lightOffFanHigh, 44, 38); 
        }
      }   
    else if (lightState == "20") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light20FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light20FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light20FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light20FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "30") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light30FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            // *** This is the copy-paste error I fixed ***
            sendRAW_Flash(light30FanLow, 44, 38); // Was light20FanLow
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light30FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light30FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "40") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light40FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light40FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light40FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light40FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "50") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light50FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light50FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light50FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light50FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "60") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light60FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light60FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light60FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light60FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "70") {
        yield();
        if(fanSpeed == "off"){
            sendRAW_Flash(light70FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light70FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light70FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light70FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "80") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light80FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light80FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light80FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light80FanHigh, 44, 38); 
        }
    
    }
    else if (lightState == "90") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light90FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light90FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light90FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light90FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "100") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light100FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light100FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light100FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light100FanHigh, 44, 38); 
        }
      }   
  }
}

// === UPDATED: set1011 (using EEPROM struct) ===
void set1011() {  
  //Remote CHQ8BT7096T DIP SWITCHES UP,DN,UP,UP OR 1011 Family Room
  static const unsigned int lightOffFanOff[] PROGMEM = {329,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,10044};
  static const unsigned int lightOffFanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,663,330,663,330,10028};
  static const unsigned int lightOffFanMed[] PROGMEM = {329,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,663,329,663,329,329,663,10028};
  static const unsigned int lightOffFanHigh[] PROGMEM = {329,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,663,329,329,663,663,329,10026};
  static const unsigned int light20FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10051};
  static const unsigned int light20FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,663,330,10045};
  static const unsigned int light20FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10041};
  static const unsigned int light20FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10041};
  static const unsigned int light30FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,10041};
  static const unsigned int light30FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,10053};
  static const unsigned int light30FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,663,330,663,330,663,330,10041};
  static const unsigned int light30FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,10034};
  static const unsigned int light40FanOff[] PROGMEM = {331,331,662,331,662,331,662,331,662,331,662,662,331,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,10036};
  static const unsigned int light40FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,331,662,662,331,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,662,331,331,662,662,331,331,662,662,331,331,662,10041};
  static const unsigned int light40FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,331,662,662,331,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,331,662,331,662,662,331,331,662,331,662,662,331,10041};
  static const unsigned int light40FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,663,330,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,10053};
  static const unsigned int light50FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10041};
  static const unsigned int light50FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,10041};
  static const unsigned int light50FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10048};
  static const unsigned int light50FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10052};
  static const unsigned int light60FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,663,330,330,663,663,330,10039};
  static const unsigned int light60FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,10034};
  static const unsigned int light60FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,331,662,662,331,331,662,331,662,331,662,662,331,331,662,662,331,331,662,662,331,662,331,331,662,331,662,662,331,662,331,662,331,662,331,10039};
  static const unsigned int light60FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,663,330,663,330,330,663,10056};
  static const unsigned int light70FanOff[] PROGMEM = {329,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,10039};
  static const unsigned int light70FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,663,330,10039};
  static const unsigned int light70FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,10049};
  static const unsigned int light70FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,10049};
  static const unsigned int light80FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10047};
  static const unsigned int light80FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,663,330,330,663,330,663,663,330,330,663,663,330,10049};
  static const unsigned int light80FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10047};
  static const unsigned int light80FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10045};
  static const unsigned int light90FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,10054};
  static const unsigned int light90FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,10034};
  static const unsigned int light90FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,663,330,663,330,663,330,10037};
  static const unsigned int light90FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,10043};
  static const unsigned int light100FanOff[] PROGMEM = {329,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,664,329,329,664,329,664,329,664,10041};
  static const unsigned int light100FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,663,330,330,663,663,330,663,330,10045};
  static const unsigned int light100FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,330,663,10043};
  static const unsigned int light100FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,663,330,10045};
 
  server.send(204,""); // Send empty response immediately

  // --- APPLY THE SAME LOGIC HERE ---
  String lastFanSpeed = String(fanSettings.fan1011_Speed);
  String lastLightState = String(fanSettings.fan1011_Light);  

  String fanSpeed = server.arg("fanSpeed");
  String lightState = server.arg("lightState");
  
  bool settingsChanged = false;
  
  if(fanSpeed == "same"){
    fanSpeed = lastFanSpeed;
  }
  else{
    strcpy(fanSettings.fan1011_Speed, fanSpeed.c_str());
    settingsChanged = true;
  }
  
  if(lightState == "same"){
    lightState = lastLightState;
  }
  else{
    strcpy(fanSettings.fan1011_Light, lightState.c_str());
    settingsChanged = true;
  }  
  
  if (settingsChanged) {
    EEPROM.put(0, fanSettings);
    EEPROM.commit();
  }

  // ... (rest of your IR sending logic for 1011) ...
  for (int i = 0; i <= IRrepeat; i++) {
     yield();  // This is PERFECT, keeps the ESP responsive
    if (lightState == "off") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(lightOffFanOff, 44,38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(lightOffFanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(lightOffFanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(lightOffFanHigh, 44, 38); 
        }
      }   
    else if (lightState == "20") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light20FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light20FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light20FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light20FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "30") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light30FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            // *** This is the copy-paste error I fixed ***
            sendRAW_Flash(light30FanLow, 44, 38); // Was light20FanLow
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light30FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light30FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "40") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light40FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light40FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light40FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light40FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "50") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light50FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light50FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light50FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light50FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "60") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light60FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light60FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light60FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light60FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "70") {
        yield();
        if(fanSpeed == "off"){
            sendRAW_Flash(light70FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light70FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light70FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light70FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "80") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light80FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light80FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light80FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light80FanHigh, 44, 38); 
        }
    
    }
    else if (lightState == "90") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light90FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light90FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light90FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light90FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "100") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light100FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light100FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light100FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light100FanHigh, 44, 38); 
        }
      }   
  }
}

// === UPDATED: set1100 (Stubbed with new logic) ===
void set1100() { 
  //FAN CHQ8BT7096T DIP SWITCHES UP,UP,DN,DN OR 1100

  static const unsigned int lightOffFanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,10043};
  static const unsigned int lightOffFanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,330,663,10048};
  static const unsigned int lightOffFanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,663,330,663,330,10045};
  static const unsigned int lightOffFanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,10035};
  static const unsigned int light20FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,10032};
  static const unsigned int light20FanLow[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,662,331,331,662,662,331,331,662,331,662,662,331,662,331,662,331,331,662,662,331,331,662,662,331,331,662,10039};
  static const unsigned int light20FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,330,663,663,330,10049};
  static const unsigned int light20FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,10045};
  static const unsigned int light30FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10041};
  static const unsigned int light30FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,10050};
  static const unsigned int light30FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10043};
  static const unsigned int light30FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10045};
  static const unsigned int light40FanOff[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,10045};
  static const unsigned int light40FanLow[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,662,331,331,662,662,331,662,331,662,331,662,331,10080};
  static const unsigned int light40FanMed[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,331,662,331,662,662,331,662,331,662,331,331,662,10058};
  static const unsigned int light40FanHigh[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,331,662,662,331,331,662,662,331,662,331,331,662,662,331,10052};
  static const unsigned int light50FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,10029};
  static const unsigned int light50FanLow[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,331,662,662,331,662,331,331,662,662,331,331,662,662,331,662,331,331,662,662,331,331,662,662,331,331,662,10041};
  static const unsigned int light50FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,10031};
  static const unsigned int light50FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,330,663,10050};
  static const unsigned int light60FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10044};
  static const unsigned int light60FanLow[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,331,662,662,331,331,662,662,331,331,662,662,331,662,331,662,331,331,662,331,662,662,331,331,662,662,331,10033};
  static const unsigned int light60FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10043};
  static const unsigned int light60FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10048};
  static const unsigned int light70FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,10043};
  static const unsigned int light70FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,10043};
  static const unsigned int light70FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,663,330,663,330,663,330,10037};
  static const unsigned int light70FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,10041};
  static const unsigned int light80FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,10049};
  static const unsigned int light80FanLow[] PROGMEM = {331,331,662,331,662,331,662,662,331,662,331,331,662,331,662,331,662,331,662,331,662,662,331,331,662,662,331,662,331,662,331,662,331,331,662,662,331,331,662,662,331,331,662,10041};
  static const unsigned int light80FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,330,663,663,330,10052};
  static const unsigned int light80FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,10039};
  static const unsigned int light90FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,10052};
  static const unsigned int light90FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,10037};
  static const unsigned int light90FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,10033};
  static const unsigned int light90FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,10041};
  static const unsigned int light100FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,330,663,663,330,10043};
  static const unsigned int light100FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,10052};
  static const unsigned int light100FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,663,330,663,330,663,330,10030};
  static const unsigned int light100FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,663,330,330,663,10033};

  server.send(204,""); // Send empty response

  // --- APPLY THE SAME LOGIC HERE ---
  String lastFanSpeed = String(fanSettings.fan1100_Speed);
  String lastLightState = String(fanSettings.fan1100_Light);  

  String fanSpeed = server.arg("fanSpeed");
  String lightState = server.arg("lightState");
  
  bool settingsChanged = false;
  
  if(fanSpeed == "same"){
    fanSpeed = lastFanSpeed;
  }
  else{
    strcpy(fanSettings.fan1100_Speed, fanSpeed.c_str());
    settingsChanged = true;
  }
  
  if(lightState == "same"){
    lightState = lastLightState;
  }
  else{
    strcpy(fanSettings.fan1100_Light, lightState.c_str());
    settingsChanged = true;
  }  
  
  if (settingsChanged) {
    EEPROM.put(0, fanSettings);
    EEPROM.commit();
  }

  for (int i = 0; i <= IRrepeat; i++) {
     yield();  // This is PERFECT, keeps the ESP responsive
    if (lightState == "off") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(lightOffFanOff, 44,38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(lightOffFanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(lightOffFanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(lightOffFanHigh, 44, 38); 
        }
      }   
    else if (lightState == "20") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light20FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light20FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light20FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light20FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "30") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light30FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            // *** This is the copy-paste error I fixed ***
            sendRAW_Flash(light30FanLow, 44, 38); // Was light20FanLow
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light30FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light30FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "40") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light40FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light40FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light40FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light40FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "50") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light50FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light50FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light50FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light50FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "60") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light60FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light60FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light60FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light60FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "70") {
        yield();
        if(fanSpeed == "off"){
            sendRAW_Flash(light70FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light70FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light70FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light70FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "80") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light80FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light80FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light80FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light80FanHigh, 44, 38); 
        }
    
    }
    else if (lightState == "90") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light90FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light90FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light90FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light90FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "100") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light100FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light100FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light100FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light100FanHigh, 44, 38); 
        }
      }   
  }
}

// === UPDATED: set1110 (Stubbed with new logic) ===
void set1110() { 
  //Remote CHQ8BT7096T DIP SWITCHES UP,UP,UP,DN OR 1110

  static const unsigned int lightOffFanOff[] PROGMEM = {329,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,10026};
  static const unsigned int lightOffFanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,330,663,10045};
  static const unsigned int lightOffFanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,10039};
  static const unsigned int lightOffFanHigh[] PROGMEM = {329,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,664,329,329,664,10039};
  static const unsigned int light20FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,663,330,663,330,10045};
  static const unsigned int light20FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,663,330,330,663,10037};
  static const unsigned int light20FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,10041};
  static const unsigned int light20FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,10048};
  static const unsigned int light30FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,10033};
  static const unsigned int light30FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,663,330,10031};
  static const unsigned int light30FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,10048};
  static const unsigned int light30FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,10041};
  static const unsigned int light40FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,10037};
  static const unsigned int light40FanLow[] PROGMEM = {331,331,662,331,662,331,662,662,331,331,662,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,662,331,331,662,331,662,662,331,662,331,662,331,10047};
  static const unsigned int light40FanMed[] PROGMEM = {331,331,662,331,662,331,662,662,331,331,662,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,331,662,331,662,331,662,662,331,662,331,331,662,10044};
  static const unsigned int light40FanHigh[] PROGMEM = {331,331,662,331,662,331,662,662,331,331,662,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,331,662,662,331,331,662,331,662,662,331,331,662,662,331,10041};
  static const unsigned int light50FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,663,330,10052};
  static const unsigned int light50FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,663,330,330,663,10039};
  static const unsigned int light50FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,10035};
  static const unsigned int light50FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,10033};
  static const unsigned int light60FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,10049};
  static const unsigned int light60FanLow[] PROGMEM = {331,331,662,331,662,331,662,662,331,331,662,331,662,331,662,331,662,331,662,662,331,331,662,662,331,331,662,662,331,662,331,662,331,331,662,662,331,662,331,331,662,662,331,10051};
  static const unsigned int light60FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,330,663,330,663,663,330,663,330,330,663,330,663,10052};
  static const unsigned int light60FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,663,330,10039};
  static const unsigned int light70FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,10048};
  static const unsigned int light70FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,10060};
  static const unsigned int light70FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,663,330,10034};
  static const unsigned int light70FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,663,330,330,663,10035};
  static const unsigned int light80FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,663,330,663,330,663,330,663,330,10028};
  static const unsigned int light80FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,663,330,330,663,330,663,330,663,663,330,330,663,10043};
  static const unsigned int light80FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,10039};
  static const unsigned int light80FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,10045};
  static const unsigned int light90FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,10045};
  static const unsigned int light90FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,663,330,663,330,330,663,663,330,10049};
  static const unsigned int light90FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,10041};
  static const unsigned int light90FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,10037};
  static const unsigned int light100FanOff[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,10033};
  static const unsigned int light100FanLow[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,663,330,330,663,330,663,330,663,10039};
  static const unsigned int light100FanMed[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,663,330,663,330,10041};
  static const unsigned int light100FanHigh[] PROGMEM = {330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,330,663,10050};


  server.send(204,""); // Send empty response

  // --- APPLY THE SAME LOGIC HERE ---
  String lastFanSpeed = String(fanSettings.fan1110_Speed);
  String lastLightState = String(fanSettings.fan1110_Light);  

  String fanSpeed = server.arg("fanSpeed");
  String lightState = server.arg("lightState");
  
  bool settingsChanged = false;
  
  if(fanSpeed == "same"){
    fanSpeed = lastFanSpeed;
  }
  else{
    strcpy(fanSettings.fan1110_Speed, fanSpeed.c_str());
    settingsChanged = true;
  }
  
  if(lightState == "same"){
    lightState = lastLightState;
  }
  else{
    strcpy(fanSettings.fan1110_Light, lightState.c_str());
    settingsChanged = true;
  }  
  
  if (settingsChanged) {
    EEPROM.put(0, fanSettings);
    EEPROM.commit();
  }
  
  for (int i = 0; i <= IRrepeat; i++) {
     yield();  // This is PERFECT, keeps the ESP responsive
    if (lightState == "off") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(lightOffFanOff, 44,38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(lightOffFanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(lightOffFanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(lightOffFanHigh, 44, 38); 
        }
      }   
    else if (lightState == "20") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light20FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light20FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light20FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light20FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "30") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light30FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            // *** This is the copy-paste error I fixed ***
            sendRAW_Flash(light30FanLow, 44, 38); // Was light20FanLow
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light30FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light30FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "40") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light40FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light40FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light40FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light40FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "50") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light50FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light50FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light50FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light50FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "60") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light60FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light60FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light60FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light60FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "70") {
        yield();
        if(fanSpeed == "off"){
            sendRAW_Flash(light70FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light70FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light70FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light70FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "80") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light80FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light80FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light80FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light80FanHigh, 44, 38); 
        }
    
    }
    else if (lightState == "90") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light90FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light90FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light90FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light90FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "100") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light100FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light100FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light100FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light100FanHigh, 44, 38); 
        }
      }   
  }
}

// === UPDATED: set1111 (Stubbed with new logic) ===
void set1111() { 
  //Remote CHQ8BT7096T DIP SWITCHES ALL UP OR 1111
  static const unsigned int lightOffFanOff[] PROGMEM = {327,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,327,666,10031};
  static const unsigned int lightOffFanLow[] PROGMEM = {329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,663,329,329,663,329,663,329,663,663,329,663,329,10076};
  static const unsigned int lightOffFanMed[] PROGMEM = {329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,664,329,329,664,10038};
  static const unsigned int lightOffFanHigh[] PROGMEM = {329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,663,329,10048};
  static const unsigned int light20FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,663,330,663,330,330,663,10042};
  static const unsigned int light20FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,663,330,10042};
  static const unsigned int light20FanMed[] PROGMEM = {330,330,664,330,664,330,664,330,664,330,664,330,664,330,664,330,664,664,330,330,664,664,330,330,664,330,664,664,330,664,330,330,664,330,664,330,664,330,664,330,664,330,664,10037};
  static const unsigned int light20FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,663,330,663,330,10043};
  static const unsigned int light30FanOff[] PROGMEM = {330,330,664,330,664,330,664,330,664,330,664,330,664,330,664,330,664,664,330,330,664,330,664,664,330,330,664,330,664,330,664,330,664,330,664,664,330,330,664,330,664,664,330,10038};
  static const unsigned int light30FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,330,663,10050};
  static const unsigned int light30FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,663,330,663,330,10042};
  static const unsigned int light30FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,10044};
  static const unsigned int light40FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,10057};
  static const unsigned int light40FanLow[] PROGMEM = {331,331,663,331,663,331,663,331,663,331,663,331,663,331,663,331,663,331,663,663,331,663,331,663,331,663,331,663,331,663,331,663,331,331,663,331,663,663,331,663,331,331,663,10050};
  static const unsigned int light40FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,663,330,663,330,663,330,330,663,330,663,330,663,663,330,330,663,663,330,10042};
  static const unsigned int light40FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,10044};
  static const unsigned int light50FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,10051};
  static const unsigned int light50FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,10034};
  static const unsigned int light50FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,10036};
  static const unsigned int light50FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,663,330,663,330,663,330,10045};
  static const unsigned int light60FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,10041};
  static const unsigned int light60FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,663,330,330,663,663,330,663,330,330,663,330,663,10038};
  static const unsigned int light60FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,663,330,10034};
  static const unsigned int light60FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,10047};
  static const unsigned int light70FanOff[] PROGMEM = {329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,10052};
  static const unsigned int light70FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,663,330,663,330,10037};
  static const unsigned int light70FanMed[] PROGMEM = {329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,663,329,663,329,329,663,10050};
  static const unsigned int light70FanHigh[] PROGMEM = {329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,663,329,329,663,663,329,10041};
  static const unsigned int light80FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,663,330,663,330,663,330,330,663,10039};
  static const unsigned int light80FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,663,330,330,663,330,663,330,663,330,663,663,330,10045};
  static const unsigned int light80FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,330,663,330,663,330,663,330,663,330,663,10037};
  static const unsigned int light80FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,663,330,330,663,663,330,663,330,663,330,663,330,10033};
  static const unsigned int light90FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,10038};
  static const unsigned int light90FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,663,330,663,330,330,663,330,663,10043};
  static const unsigned int light90FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,663,330,10047};
  static const unsigned int light90FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,10051};
  static const unsigned int light100FanOff[] PROGMEM = {329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,664,329,329,664,329,664,10057};
  static const unsigned int light100FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,663,330,330,663,330,663,663,330,663,330,663,330,10043};
  static const unsigned int light100FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,330,663,663,330,663,330,330,663,10034};
  static const unsigned int light100FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,663,330,10038};


  server.send(204,""); // Send empty response

  // --- APPLY THE SAME LOGIC HERE ---
  String lastFanSpeed = String(fanSettings.fan1111_Speed);
  String lastLightState = String(fanSettings.fan1111_Light);  

  String fanSpeed = server.arg("fanSpeed");
  String lightState = server.arg("lightState");
  
  bool settingsChanged = false;
  
  if(fanSpeed == "same"){
    fanSpeed = lastFanSpeed;
  }
  else{
    strcpy(fanSettings.fan1111_Speed, fanSpeed.c_str());
    settingsChanged = true;
  }
  
  if(lightState == "same"){
    lightState = lastLightState;
  }
  else{
    strcpy(fanSettings.fan1111_Light, lightState.c_str());
    settingsChanged = true;
  }  
  
  if (settingsChanged) {
    EEPROM.put(0, fanSettings);
    EEPROM.commit();
  }
  
  for (int i = 0; i <= IRrepeat; i++) {
     yield();  // This is PERFECT, keeps the ESP responsive
    if (lightState == "off") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(lightOffFanOff, 44,38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(lightOffFanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(lightOffFanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(lightOffFanHigh, 44, 38); 
        }
      }   
    else if (lightState == "20") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light20FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light20FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light20FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light20FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "30") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light30FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            // *** This is the copy-paste error I fixed ***
            sendRAW_Flash(light30FanLow, 44, 38); // Was light20FanLow
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light30FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light30FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "40") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light40FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light40FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light40FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light40FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "50") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light50FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light50FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light50FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light50FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "60") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light60FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light60FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light60FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light60FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "70") {
        yield();
        if(fanSpeed == "off"){
            sendRAW_Flash(light70FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light70FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light70FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light70FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "80") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light80FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light80FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light80FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light80FanHigh, 44, 38); 
        }
    
    }
    else if (lightState == "90") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light90FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light90FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light90FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light90FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "100") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light100FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light100FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light100FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light100FanHigh, 44, 38); 
        }
      }   
  }
}

// === UPDATED: set1101 (Stubbed with new logic) ===
void set1101() { 
  //FAN CHQ8BT7096T DIP SWITCHES UP,UP,DN,UP OR 1101
  static const unsigned int lightOffFanOff[] PROGMEM = {329,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,329,664,664,329,329,664,329,664,329,664,10054};
  static const unsigned int lightOffFanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,663,330,10050};
  static const unsigned int lightOffFanMed[] PROGMEM = {329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,663,329,329,663,663,329,329,663,10037};
  static const unsigned int lightOffFanHigh[] PROGMEM = {329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,663,329,329,663,329,663,663,329,10042};
  static const unsigned int light20FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,10045};
  static const unsigned int light20FanLow[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,662,330,330,662,662,330,330,662,330,662,662,330,662,330,662,330,330,662,662,330,330,662,330,662,662,330,10040};
  static const unsigned int light20FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,10036};
  static const unsigned int light20FanHigh[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,662,330,330,662,662,330,330,662,330,662,662,330,330,662,662,330,330,662,330,662,662,330,662,330,662,330,10044};
  static const unsigned int light30FanOff[] PROGMEM = {329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,663,329,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,10035};
  static const unsigned int light30FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,330,663,10026};
  static const unsigned int light30FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,10047};
  static const unsigned int light30FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,10049};
  static const unsigned int light40FanOff[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,662,330,662,330,662,330,662,330,662,330,330,662,330,662,330,662,662,330,330,662,662,330,662,330,10028};
  static const unsigned int light40FanLow[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,662,331,331,662,662,331,662,331,662,331,331,662,10030};
  static const unsigned int light40FanMed[] PROGMEM = {331,331,662,331,662,331,662,331,662,662,331,331,662,331,662,331,662,331,662,662,331,662,331,662,331,662,331,662,331,662,331,331,662,331,662,662,331,662,331,331,662,662,331,10050};
  static const unsigned int light40FanHigh[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,662,330,662,330,662,330,662,330,662,330,330,662,662,330,330,662,662,330,662,330,330,662,330,662,10037};
  static const unsigned int light50FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,10037};
  static const unsigned int light50FanLow[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,662,330,662,330,330,662,662,330,330,662,662,330,662,330,330,662,662,330,330,662,330,662,662,330,10052};
  static const unsigned int light50FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,663,330,330,663,330,663,663,330,330,663,330,663,330,663,10033};
  static const unsigned int light50FanHigh[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,662,330,662,330,330,662,662,330,330,662,330,662,662,330,330,662,330,662,662,330,662,330,662,330,10037};
  static const unsigned int light60FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,10027};
  static const unsigned int light60FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,330,663,10036};
  static const unsigned int light60FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,10038};
  static const unsigned int light60FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,330,663,663,330,330,663,330,663,330,663,663,330,330,663,10044};
  static const unsigned int light70FanOff[] PROGMEM = {329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,663,329,329,663,329,663,10038};
  static const unsigned int light70FanLow[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,662,330,662,330,330,662,662,330,662,330,662,330,662,330,10035};
  static const unsigned int light70FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,663,330,663,330,663,330,330,663,10037};
  static const unsigned int light70FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,663,330,10038};
  static const unsigned int light80FanOff[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,330,663,330,663,330,663,330,663,663,330,663,330,330,663,10036};
  static const unsigned int light80FanLow[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,330,662,662,330,330,662,662,330,662,330,662,330,662,330,330,662,662,330,330,662,330,662,662,330,10042};
  static const unsigned int light80FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,10035};
  static const unsigned int light80FanHigh[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,330,662,662,330,330,662,662,330,662,330,330,662,662,330,330,662,330,662,662,330,662,330,662,330,10044};
  static const unsigned int light90FanOff[] PROGMEM = {329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,663,329,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,10032};
  static const unsigned int light90FanLow[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,663,330,330,663,330,663,663,330,330,663,330,663,10036};
  static const unsigned int light90FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,663,330,330,663,330,663,330,663,330,663,663,330,663,330,10042};
  static const unsigned int light90FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,330,663,330,663,330,663,663,330,330,663,10038};
  static const unsigned int light100FanOff[] PROGMEM = {329,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,329,663,329,663,329,663,329,663,329,663,663,329,329,663,329,663,329,663,663,329,663,329,329,663,329,663,10034};
  static const unsigned int light100FanLow[] PROGMEM = {330,330,662,330,662,330,662,330,662,662,330,330,662,330,662,330,662,330,662,330,662,330,662,330,662,330,662,662,330,662,330,662,330,330,662,662,330,662,330,662,330,662,330,10042};
  static const unsigned int light100FanMed[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,663,330,330,663,330,663,663,330,663,330,663,330,330,663,10044};
  static const unsigned int light100FanHigh[] PROGMEM = {330,330,663,330,663,330,663,330,663,663,330,330,663,330,663,330,663,330,663,330,663,330,663,330,663,330,663,663,330,330,663,663,330,330,663,663,330,663,330,330,663,663,330,10042};

  server.send(204,""); // Send empty response

  // --- APPLY THE SAME LOGIC HERE ---
  String lastFanSpeed = String(fanSettings.fan1101_Speed);
  String lastLightState = String(fanSettings.fan1101_Light);  

  String fanSpeed = server.arg("fanSpeed");
  String lightState = server.arg("lightState");
  
  bool settingsChanged = false;
  
  if(fanSpeed == "same"){
    fanSpeed = lastFanSpeed;
  }
  else{
    strcpy(fanSettings.fan1101_Speed, fanSpeed.c_str());
    settingsChanged = true;
  }
  
  if(lightState == "same"){
    lightState = lastLightState;
  }
  else{
    strcpy(fanSettings.fan1101_Light, lightState.c_str());
    settingsChanged = true;
  }  
  
  if (settingsChanged) {
    EEPROM.put(0, fanSettings);
    EEPROM.commit();
  }

  // --- ADD YOUR PROGMEM ARRAYS FOR 1101 HERE ---
  
  for (int i = 0; i <= IRrepeat; i++) {
     yield();  // This is PERFECT, keeps the ESP responsive
    if (lightState == "off") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(lightOffFanOff, 44,38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(lightOffFanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(lightOffFanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(lightOffFanHigh, 44, 38); 
        }
      }   
    else if (lightState == "20") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light20FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light20FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light20FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light20FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "30") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light30FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            // *** This is the copy-paste error I fixed ***
            sendRAW_Flash(light30FanLow, 44, 38); // Was light20FanLow
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light30FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light30FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "40") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light40FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light40FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light40FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light40FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "50") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light50FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light50FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light50FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light50FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "60") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light60FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light60FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light60FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light60FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "70") {
        yield();
        if(fanSpeed == "off"){
            sendRAW_Flash(light70FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light70FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light70FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light70FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "80") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light80FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light80FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light80FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light80FanHigh, 44, 38); 
        }
    
    }
    else if (lightState == "90") {
        if(fanSpeed == "off"){
            sendRAW_Flash(light90FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light90FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light90FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light90FanHigh, 44, 38); 
        }    
    }
    else if (lightState == "100") { 
        if(fanSpeed == "off"){
            sendRAW_Flash(light100FanOff, 44, 38); 
        }
        else if(fanSpeed == "low"){
            sendRAW_Flash(light100FanLow, 44, 38); 
        }
        else if(fanSpeed == "med"){
            sendRAW_Flash(light100FanMed, 44, 38); 
        }
        else if(fanSpeed == "high"){
            sendRAW_Flash(light100FanHigh, 44, 38); 
        }
      }   
  }
}


// === Main Loop ===
void loop() {
  ArduinoOTA.handle();
  server.handleClient();

  // === Check for 5-min initial ping delay ===
  if (!initialPingsDone && (millis() - bootMillis >= PING_DELAY_MS)) {
    //Serial.println("5-minute boot delay complete. Performing initial pings...");

    // === PING #1 ===
    //Serial.printf("Pinging %s ... ", PING_TARGET1);
    bool pingOk1 = Ping.ping(PING_TARGET1, 1);
    if (pingOk1) {
      //Serial.println("reply received; pulse1 NOT scheduled.");
    } else {
      //Serial.println("no reply; scheduling pulse1.");
      pulse1StartDeadline = millis() + PULSE1_DELAY_MS; // Schedule from *now*
      pulse1Stage = SCHEDULED;
    }
    
    // === PING #2 ===
    //Serial.printf("Pinging %s ... ", PING_TARGET2);
    bool pingOk2 = Ping.ping(PING_TARGET2, 1);
    if (pingOk2) {
      //Serial.println("reply received; pulse2 NOT scheduled.");
    } else {
      //Serial.println("no reply; scheduling pulse2.");
      pulse2StartDeadline = millis() + PULSE2_DELAY_MS; // Schedule from *now*
      pulse2Stage = SCHEDULED;
    }

    initialPingsDone = true; // Run only once
  }

  // === Non-blocking pulse logic ===
  unsigned long now = millis();

  // --- Pulse 1 state machine ---
  if (pulse1Stage == SCHEDULED && now >= pulse1StartDeadline) {
    //Serial.println("Starting pulse 1 (10s)");
    digitalWrite(PULSE1_PIN, HIGH);
    pulse1ActiveStart = now;
    pulse1Stage = ACTIVE;
  }
  else if (pulse1Stage == ACTIVE && now - pulse1ActiveStart >= PULSE1_WIDTH_MS) {
    //Serial.println("Ending pulse 1");
    digitalWrite(PULSE1_PIN, LOW);
    pulse1Stage = DONE;
  }

  // --- Pulse 2 state machine ---
  if (pulse2Stage == SCHEDULED && now >= pulse2StartDeadline) {
    //Serial.println("Starting pulse 2 (0.5s)");
    digitalWrite(PULSE2_PIN, HIGH);
    pulse2ActiveStart = now;
    pulse2Stage = ACTIVE;
  }
  else if (pulse2Stage == ACTIVE && now - pulse2StartDeadline >= PULSE2_WIDTH_MS) {
    //Serial.println("Ending pulse 2");
    digitalWrite(PULSE2_PIN, LOW);
    pulse2Stage = DONE;
  }

  // === Non-blocking sensor poll ===
  if (now - lastPoll >= POLL_INTERVAL_MS) {
    lastPoll = now;
    float lux = lightMeter.readLightLevel();

    if (lux < 0) {
      //Serial.println("BH1750 read error");
      lastStateValid = false; // Invalidate state on read error
    } else {
      //Serial.print("Lux: ");
      //Serial.println(lux);

      // 1. Determine the current state
      bool currentIsOn = (lux > LUX_THRESHOLD); // 'On' means lux is HIGH
      String commandToSend = ""; // Temp var to hold command

      // 2. Check if this is the first valid reading
      if (!lastStateValid) {
        //Serial.println("First valid read. Sending initial state.");
        commandToSend = currentIsOn ? HE_CMD_ON : HE_CMD_OFF;
        
      // 3. Check if the state has *changed*
      } else if (currentIsOn != lastIsOn) {
        //Serial.print("Lux state changed. Sending update: ");
        commandToSend = currentIsOn ? HE_CMD_ON : HE_CMD_OFF;
        //Serial.println(commandToSend);
      } 
      // else: State is unchanged, do nothing.

      // 4. Send the command if one was set
      if (commandToSend != "") {
        sendToHubitat(commandToSend); 
      }

      // 5. Save the new state for the next loop
      lastIsOn = currentIsOn;
      lastStateValid = true;
    }
  }
}
